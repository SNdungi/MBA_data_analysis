{% extends "layout.html" %}

{% block content %}
<style>
    /* --- LAYOUT & TRANSITIONS --- */
    .tutorial-container {
        display: flex;
        height: calc(100vh - 3.5rem); /* Full height minus navbar */
        overflow: hidden;
        background-color: #f8f9fa;
    }

    /* --- COLUMN 1: CURRICULUM SIDEBAR --- */
    .sidebar-curriculum {
        width: 180px; /* Fixed slim width */
        min-width: 180px;
        background: #fff;
        border-right: 1px solid #e9ecef;
        overflow-y: auto;
        transition: margin-left 0.3s ease;
        position: relative;
        z-index: 10;
    }
    .sidebar-curriculum.collapsed {
        margin-left: -180px;
    }

    /* --- COLUMN 2: SUBTOPIC SIDEBAR --- */
    .sidebar-subtopic {
        width: 180px; /* Even slimmer */
        min-width: 180px;
        background: #fdfdfd;
        border-right: 1px solid #e9ecef;
        overflow-y: auto;
        transition: margin-left 0.3s ease;
        position: relative;
        z-index: 5;
    }
    .sidebar-subtopic.collapsed {
        margin-left: -180px;
    }

    /* --- COLUMN 3: MAIN CONTENT --- */
    .main-content-area {
        flex: 1;
        overflow-y: auto;
        padding: 2rem;
        background-color: #f8f9fa;
        position: relative;
    }

    /* --- TOGGLE BUTTONS --- */
    .toggle-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 20px;
        height: 20px;
        border-radius: 4px;
        background: var(--fluidcore-cream);
        color: var(--fluidcore-teal);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 0.5rem;
        z-index: 20;
    }
    .toggle-btn:hover {
        color: var(--app-bg);
        background: var(--fluidcore-gold);
    }

    /* Floating Re-Open Buttons (Visible when collapsed) */
    .reopen-btn {
        position: absolute;
        top: 50%;
        left: 0;
        transform: translateY(-50%);
        width: 20px;
        height: 40px;
        background: #fff;
        border: 1px solid #dee2e6;
        border-left: none;
        border-radius: 0 4px 4px 0;
        cursor: pointer;
        display: none; /* Hidden by default */
        align-items: center;
        justify-content: center;
        color: var(--fluidcore-teal);
        box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        z-index: 100;
    }
    .reopen-btn:hover { background: #f8f9fa; }

    /* --- LIST STYLES (Retained & Refined) --- */
    .level-header {
        font-size: 0.65rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #8b9996ff;
        padding: 1.5rem 1rem 0.5rem;
    }
    .section-toggler {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 1rem;
        font-size: 0.75rem;
        font-weight: 600;
        color: #495057;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
    }
    .section-toggler:hover { background-color: #f8f9fa; color: var(--fluidcore-teal); }
    .section-toggler.active { color: var(--fluidcore-teal); background-color: #f1f3f5; }
    
    .topic-list { display: none; padding: 0; margin: 0; list-style: none; background: #fff; }
    .topic-list.show { display: block; }
    
    .topic-item {
        display: block;
        padding: 0.35rem 1rem 0.35rem 1.8rem;
        font-size: 0.75rem;
        color: #6c757d;
        text-decoration: none;
        border-left: 2px solid transparent;
    }
    .topic-item:hover { color: #212529; background: #fafafa; }
    
    /* Highlight Active Topic */
    .topic-item.active {
        background-color: #eef2f3;
        color: var(--fluidcore-teal);
        border-left-color: var(--fluidcore-orange);
        font-weight: 600;
    }

    /* Subtopic Links */
    .subtopic-header {
        padding: 1rem;
        font-size: 0.6rem;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--fluidcore-teal);
        border-bottom: 1px solid #e9ecef;
        background: #fdfdfd;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .subtopic-link {
        display: block;
        padding: 0.5rem 1rem;
        font-size: 0.75rem;
        color: #495057;
        text-decoration: none;
        border-bottom: 1px solid #f8f9fa;
    }
    .subtopic-link:hover { background-color: #e8e8e9ff; color: #000; }
    .subtopic-link.active { background-color: var(--fluidcore-teal); color: #fff; }

</style>

<div class="tutorial-container">
    
    <!-- 1. CURRICULUM SIDEBAR -->
    <div id="sidebar-curr" class="sidebar-curriculum">
        <button class="toggle-btn" onclick="toggleSidebar('curr')" title="Collapse Sidebar">
            <i class="fas fa-chevron-left"></i>
        </button>

        {% for level in levels %}
            <div class="level-header">{{ level.title }}</div>
            {% for section in level.sections %}
                <!-- Check if this section contains the active topic/subtopic -->
                {% set current_topic_id = active_topic.id if active_topic else (active_subtopic.topic.id if active_subtopic else -1) %}
                
                {% set is_section_active = False %}
                {% for t in section.topics %}
                    {% if t.id == current_topic_id %}{% set is_section_active = True %}{% endif %}
                {% endfor %}
                
                <div class="section-toggler {% if is_section_active %}active{% endif %}" 
                     onclick="toggleSection('sec-{{ section.id }}', this)">
                    <span>{{ section.title }}</span>
                    <i class="fas fa-chevron-right {% if is_section_active %}fa-rotate-90{% endif %}" style="font-size: 0.6rem;"></i>
                </div>

                <ul id="sec-{{ section.id }}" class="topic-list {% if is_section_active %}show{% endif %}">
                    {% for topic in section.topics %}
                        <li>
                            <a href="{{ url_for('tutorials.view_topic', topic_id=topic.id) }}" 
                               class="topic-item {% if topic.id == current_topic_id %}active{% endif %}">
                                {{ topic.title }}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            {% endfor %}
        {% endfor %}
    </div>

    <!-- Reopen Button for Curriculum -->
    <div id="btn-open-curr" class="reopen-btn" onclick="toggleSidebar('curr')" title="Open Curriculum">
        <i class="fas fa-list"></i>
    </div>


    <!-- 2. SUBTOPIC SIDEBAR (Conditional) -->
    {% if active_topic or active_subtopic %}
        {% set current_topic = active_topic if active_topic else active_subtopic.topic %}
        
        <div id="sidebar-sub" class="sidebar-subtopic">
            <button class="toggle-btn" onclick="toggleSidebar('sub')" title="Collapse Lessons">
                <i class="fas fa-chevron-left"></i>
            </button>

            <div class="subtopic-header">
                {{ current_topic.title }}
            </div>
            
            {% for sub in current_topic.subtopics %}
                <a href="{{ url_for('tutorials.view', subtopic_id=sub.id) }}" 
                   class="subtopic-link {% if active_subtopic and active_subtopic.id == sub.id %}active{% endif %}">
                    {{ sub.title }}
                </a>
            {% endfor %}
            
            {% if not current_topic.subtopics %}
                <div class="p-3 text-muted small text-center opacity-50">No lessons yet.</div>
            {% endif %}
        </div>

        <!-- Reopen Button for Subtopic -->
        <div id="btn-open-sub" class="reopen-btn" onclick="toggleSidebar('sub')" style="left: 0;" title="Open Lessons">
            <i class="fas fa-tasks"></i>
        </div>
    {% endif %}


    <!-- 3. MAIN CONTENT -->
    <div class="main-content-area">
        {% if active_topic or active_subtopic %}
            {% block tutorial_content %}{% endblock %}
        {% else %}
            <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                <div class="text-center opacity-50">
                    <i class="fas fa-graduation-cap fa-3x mb-3"></i>
                    <p>Select a topic to begin learning.</p>
                </div>
            </div>
        {% endif %}
    </div>

</div>

<script>
    // --- SIDEBAR TOGGLING LOGIC ---
    
    // Load saved states on page load
    document.addEventListener("DOMContentLoaded", function() {
        if(localStorage.getItem('sidebar-curr-closed') === 'true') toggleSidebar('curr', false);
        if(localStorage.getItem('sidebar-sub-closed') === 'true') toggleSidebar('sub', false);
    });

    function toggleSidebar(type, saveState = true) {
        const sidebar = document.getElementById('sidebar-' + type);
        const openBtn = document.getElementById('btn-open-' + type);
        
        if (!sidebar) return;

        // Toggle Class
        const isClosed = sidebar.classList.toggle('collapsed');
        
        // Show/Hide Reopen Button
        if (openBtn) openBtn.style.display = isClosed ? 'flex' : 'none';

        // Adjust 'Left' position of the Subtopic Reopen Button based on Curriculum state
        if (type === 'curr') {
            const subBtn = document.getElementById('btn-open-sub');
            if(subBtn) {
                // If curriculum is closed, sub-button moves to left edge. If open, it moves right.
                // NOTE: CSS margins handle the flow, but absolute buttons need help.
                // Simpler approach: Just let them stack or hide. 
                // For this sleek design, we rely on the flow.
            }
        }

        // Save State
        if (saveState) {
            localStorage.setItem('sidebar-' + type + '-closed', isClosed);
        }
    }

    // --- ACCORDION LOGIC ---
    function toggleSection(id, header) {
        const list = document.getElementById(id);
        const icon = header.querySelector('.fa-chevron-right');
        
        if (list.classList.contains('show')) {
            list.classList.remove('show');
            header.classList.remove('active');
            if(icon) icon.classList.remove('fa-rotate-90');
        } else {
            // Optional: Close others
            // document.querySelectorAll('.topic-list').forEach(el => el.classList.remove('show'));
            // document.querySelectorAll('.section-toggler').forEach(el => el.classList.remove('active'));
            
            list.classList.add('show');
            header.classList.add('active');
            if(icon) icon.classList.add('fa-rotate-90');
        }
    }
</script>
{% endblock %}