{% extends "base_setup.html" %}

{% block file_content %}

<!-- 1. EXTERNAL ASSETS -->
<script src="//unpkg.com/mathlive"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
    /* --- THEME VARIABLES --- */
    :root {
        --fc-teal: #23797c;
        --fc-teal-light: #e6fcf5;
        --fc-orange: #f37021;
        --fc-border: #e9ecef;
        --fc-gray-bg: #f8f9fa;
        --fc-text-dark: #343a40;
    }

    /* 
       CRITICAL FIX FOR MATHLIVE:
       1. Set keyboard z-index higher than Bootstrap Modal (1055) 
    */
    body { 
        font-family: 'Inter', sans-serif; 
        background-color: #f1f3f5; 
        color: var(--fc-text-dark);
        --keyboard-zindex: 3000 !important; 
    }

    /* --- LAYOUT --- */
    .dashboard-container { display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

    /* Top Nav */
    .top-nav { background: white; border-bottom: 1px solid var(--fc-border); padding: 0.75rem 1.5rem; }
    .nav-card { background: var(--fc-gray-bg); border: 1px solid var(--fc-border); border-radius: 6px; padding: 0.5rem 1rem; }
    .nav-label { font-size: 0.65rem; font-weight: 700; color: #6c757d; text-transform: uppercase; margin-bottom: 0.25rem; }

    /* Workspace */
    .workspace { display: flex; flex: 1; overflow: hidden; }
    .sidebar { width: 300px; background: white; border-right: 1px solid var(--fc-border); display: flex; flex-direction: column; }
    .sidebar-header { padding: 1rem; border-bottom: 1px solid var(--fc-border); background: var(--fc-gray-bg); }
    .subtopic-item { padding: 0.85rem 1.25rem; border-bottom: 1px solid #f1f3f5; cursor: pointer; font-size: 0.85rem; display: flex; justify-content: space-between; }
    .subtopic-item:hover { background-color: var(--fc-gray-bg); }
    .subtopic-item.active { background-color: var(--fc-teal-light); color: var(--fc-teal); font-weight: 600; border-left: 4px solid var(--fc-teal); }

    /* Editor Pane */
    .editor-pane { flex: 1; overflow-y: auto; background: white; position: relative; padding: 2rem; }
    #editor-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.96); z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    
    .editor-label { font-size: 0.75rem; font-weight: 700; color: var(--fc-text-dark); margin-bottom: 0.4rem; display: block; }
    .form-control-sm, .form-select-sm { border-radius: 4px; border: 1px solid #ced4da; }

    /* --- QUILL & TOOLBARS --- */
    .quill-wrapper { background: white; border-radius: 4px; border: 1px solid #ced4da; margin-bottom: 1rem; overflow: hidden; }
    
    /* Custom Toolbar Styling */
    .custom-toolbar { background: var(--fc-gray-bg); border-bottom: 1px solid #ced4da; padding: 5px 10px; display: flex; align-items: center; gap: 10px; }
    .ql-container.ql-snow { border: none !important; font-family: 'Inter', sans-serif; font-size: 0.95rem; }
    
    /* The Visual Math Button inside Toolbar */
    .btn-math-insert {
        background-color: var(--fc-teal); color: white; border: none; 
        font-size: 0.75rem; font-weight: 600; padding: 4px 12px; border-radius: 4px;
        display: inline-flex; align-items: center; transition: 0.2s;
    }
    .btn-math-insert:hover { background-color: #1a5c5e; color: white; }

    /* Image Upload Strip */
    .upload-strip {
        border: 2px dashed #dee2e6; border-radius: 6px; padding: 0.75rem;
        background: #fdfdfd; display: flex; align-items: center; justify-content: space-between;
        cursor: pointer; transition: 0.2s; margin-bottom: 1rem;
    }
    .upload-strip:hover { border-color: var(--fc-teal); background: #f8f9fa; }
    .img-preview-row { display: flex; gap: 10px; overflow-x: auto; padding-left: 10px; }
    .img-thumb-mini { height: 40px; border-radius: 4px; border: 1px solid #ddd; }

    /* MathLive Field Styling */
    math-field { 
        font-size: 1.5rem; 
        padding: 15px; 
        border: 1px solid #ced4da; 
        border-radius: 6px; 
        width: 100%; 
        background: #fff;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }
    math-field:focus-within {
        outline: 2px solid var(--fc-teal);
        border-color: transparent;
    }
</style>

<div class="dashboard-container">
    
    <!-- 1. NAVIGATION -->
    <div class="top-nav">
        <div class="row g-2">
            <!-- Level -->
            <div class="col-md-3">
                <div class="nav-card">
                    <div class="nav-label">1. Level</div>
                    <select id="sel-level" class="form-select form-select-sm" onchange="loadSections()">
                        <option value="" selected disabled>-- Select --</option>
                        {% for level in levels %}<option value="{{ level.id }}">{{ level.title }}</option>{% endfor %}
                    </select>
                </div>
            </div>
            <!-- Section -->
            <div class="col-md-3">
                <div class="nav-card">
                    <div class="d-flex justify-content-between"><div class="nav-label">2. Section</div><i class="fas fa-plus text-success pointer" onclick="toggleAdd('section')"></i></div>
                    <div id="view-section-select"><select id="sel-section" class="form-select form-select-sm" onchange="loadTopics()" disabled></select></div>
                    <div id="view-section-add" class="d-none"><input id="new-section-title" class="form-control form-control-sm" placeholder="New..."><button class="btn btn-sm btn-success w-100 mt-1" onclick="addItem('section')">Add</button></div>
                </div>
            </div>
            <!-- Topic -->
            <div class="col-md-3">
                <div class="nav-card">
                    <div class="d-flex justify-content-between"><div class="nav-label">3. Topic</div><i class="fas fa-plus text-success pointer" onclick="toggleAdd('topic')"></i></div>
                    <div id="view-topic-select"><select id="sel-topic" class="form-select form-select-sm" onchange="loadSubtopics()" disabled></select></div>
                    <div id="view-topic-add" class="d-none"><input id="new-topic-title" class="form-control form-control-sm" placeholder="New..."><button class="btn btn-sm btn-success w-100 mt-1" onclick="addItem('topic')">Add</button></div>
                </div>
            </div>
            <!-- Tools -->
            <div class="col-md-3 text-end pt-3">
                <button class="btn btn-sm btn-outline-danger" onclick="deleteItem()"><i class="fas fa-trash-alt"></i></button>
            </div>
        </div>
    </div>

    <!-- 2. WORKSPACE -->
    <div class="workspace">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header d-flex justify-content-between align-items-center">
                <span class="small fw-bold text-muted">UNITS</span>
                <button class="btn btn-sm btn-dark rounded-pill px-3" onclick="initNewSubtopic()">New</button>
            </div>
            <div id="subtopic-list" style="overflow-y:auto; flex:1;">
                <div class="text-center mt-5 text-muted small">Select a Topic</div>
            </div>
        </div>

        <!-- Editor -->
        <div class="editor-pane">
            <div id="editor-overlay">
                <i class="fas fa-lock fa-3x text-muted mb-3 opacity-25"></i>
                <h6>Editor Locked</h6>
            </div>

            <form id="editor-form">
                <input type="hidden" id="edit-subtopic-id" name="subtopic_id">
                
                <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-4">
                    <h5 id="editor-header" class="mb-0 fw-bold">New Unit</h5>
                    <button type="button" class="btn btn-sm btn-outline-danger border-0" id="btn-delete-sub" onclick="deleteSubtopic()" style="display:none;">Delete</button>
                </div>

                <div class="row g-3">
                    <div class="col-md-8">
                        <label class="editor-label">Title</label>
                        <input type="text" class="form-control form-control-sm" id="edit-title" name="title" required>
                    </div>
                    <div class="col-md-4">
                        <label class="editor-label">Video URL</label>
                        <input type="text" class="form-control form-control-sm" id="edit-video" name="video_url">
                    </div>
                    <div class="col-12">
                        <label class="editor-label">Short Summary</label>
                        <input type="text" class="form-control form-control-sm" id="edit-desc" name="short_description">
                    </div>

                    <!-- CONCEPT NOTES (Standard Quill) -->
                    <div class="col-12 mt-2">
                        <label class="editor-label text-primary">Concept Notes</label>
                        <div class="quill-wrapper">
                            <div id="quill-notes" style="height: 150px;"></div>
                        </div>
                        <input type="hidden" name="definition_text" id="hidden-notes">
                    </div>

                    <!-- WORKED EXAMPLE (Refined Layout) -->
                    <div class="col-12 border-top pt-4 mt-2">
                        <h6 class="fw-bold text-dark mb-3"><i class="fas fa-chalkboard me-2"></i>Worked Example</h6>

                        <!-- A. Image Strip (Top) -->
                        <div class="upload-strip" onclick="document.getElementById('img-input').click()">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-images text-muted me-3 fa-lg"></i>
                                <div>
                                    <span class="d-block small fw-bold text-dark">Reference Images</span>
                                    <span class="d-block small text-muted" style="font-size:0.7rem;">Click to upload snippets (Max 2MB)</span>
                                </div>
                            </div>
                            <div id="image-preview-container" class="img-preview-row"></div>
                            <input type="file" id="img-input" class="d-none" onchange="uploadImage(this)">
                        </div>

                        <!-- B. Editor with Custom Header (Bottom) -->
                        <label class="editor-label">Step-by-Step Solution</label>
                        <div class="quill-wrapper">
                            <!-- Custom Toolbar Header -->
                            <div id="example-toolbar" class="custom-toolbar">
                                <!-- Standard Formats -->
                                <span class="ql-formats">
                                    <button class="ql-bold"></button>
                                    <button class="ql-italic"></button>
                                    <button class="ql-underline"></button>
                                </span>
                                <span class="ql-formats">
                                    <button class="ql-list" value="ordered"></button>
                                    <button class="ql-list" value="bullet"></button>
                                </span>
                                <span class="ql-formats">
                                    <button class="ql-script" value="sub"></button>
                                    <button class="ql-script" value="super"></button>
                                </span>
                                <span class="ql-formats">
                                    <button class="ql-clean"></button>
                                </span>
                                <!-- THE VISUAL MATH BUTTON -->
                                <span class="ql-formats border-start ps-2 ms-2">
                                    <button type="button" class="btn-math-insert" onclick="openMathModal()">
                                        <i class="fas fa-calculator me-2 text-black"></i> 
                                    </button>
                                </span>
                            </div>
                            <!-- Editor Body -->
                            <div id="quill-example" style="height: 200px;"></div>
                        </div>
                        <input type="hidden" name="examples" id="hidden-examples-json">
                    </div>
                </div>

                <div class="mt-4 pt-3 border-top text-end">
                    <button type="button" class="btn btn-light me-2" onclick="loadSubtopics()">Discard</button>
                    <button type="button" class="btn btn-primary px-4" onclick="saveSubtopic()" style="background:var(--fc-teal); border:none;">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- MATH MODAL 
     CRITICAL FIX: data-bs-backdrop="static" prevents Bootstrap from closing the modal 
     when clicking the visual keyboard (which is technically outside the modal div) 
-->
<div class="modal fade" id="mathModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content shadow border-0">
      <div class="modal-header bg-dark text-white py-2">
        <h6 class="modal-title small fw-bold">VISUAL FORMULA BUILDER</h6>
        <!-- We use a custom close function to ensure focus clears -->
        <button type="button" class="btn-close btn-close-white" onclick="closeMathModal()"></button>
      </div>
      <div class="modal-body bg-light">
          <!-- virtual-keyboard-mode=onfocus ensures the keyboard pops up only when user clicks inside -->
          <math-field id="math-input" virtual-keyboard-mode="onfocus"></math-field>
          <div class="text-muted small mt-2 d-flex justify-content-between">
              <span>Type <code>/sqrt</code>, <code>/frac</code>, or use the on-screen keyboard.</span>
              <span id="latex-preview" class="text-primary font-monospace"></span>
          </div>
      </div>
      <div class="modal-footer py-1">
        <button type="button" class="btn btn-sm btn-secondary" onclick="closeMathModal()">Cancel</button>
        <button type="button" class="btn btn-sm btn-primary" onclick="insertMath()">Insert Formula</button>
      </div>
    </div>
  </div>
</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
<script>
    // --- 1. INITIALIZE EDITORS ---
    // Notes Editor (Standard Toolbar)
    const quillNotes = new Quill('#quill-notes', {
        theme: 'snow',
        modules: { toolbar: [['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['clean']] }
    });

    // Example Editor (CUSTOM TOOLBAR LINKED VIA ID)
    const quillEx = new Quill('#quill-example', {
        theme: 'snow',
        modules: { toolbar: '#example-toolbar' } // This links to the custom HTML header
    });

    const mf = document.getElementById('math-input');
    
    // Live LaTeX preview
    mf.addEventListener('input', (ev) => {
        document.getElementById('latex-preview').innerText = mf.value;
    });

    // --- 2. STATE & LOGIC ---
    let state = { level: null, section: null, topic: null, subtopic: null };
    let currentImages = [];
    let mathModalInstance = null;

    function toggleOverlay(show) {
        const ov = document.getElementById('editor-overlay');
        show ? (ov.classList.remove('d-none'), ov.classList.add('d-flex')) : (ov.classList.remove('d-flex'), ov.classList.add('d-none'));
    }

    function loadSections() {
        const id = document.getElementById('sel-level').value;
        state.level = id; resetUI('section');
        fetch(`/tutorial_admin/api/sections/${id}`).then(r=>r.json()).then(d=>{
            const s = document.getElementById('sel-section');
            s.innerHTML='<option value="" disabled selected>-- Select --</option>';
            d.forEach(i=>s.innerHTML+=`<option value="${i.id}">${i.title}</option>`);
            s.disabled=false;
        });
    }
    function loadTopics() {
        const id = document.getElementById('sel-section').value;
        state.section=id; resetUI('topic');
        fetch(`/tutorial_admin/api/topics/${id}`).then(r=>r.json()).then(d=>{
            const s = document.getElementById('sel-topic');
            s.innerHTML='<option value="" disabled selected>-- Select --</option>';
            d.forEach(i=>s.innerHTML+=`<option value="${i.id}">${i.title}</option>`);
            s.disabled=false;
        });
    }
    function loadSubtopics(activeId=null) {
        const id = document.getElementById('sel-topic').value;
        state.topic=id; toggleOverlay(false); if(!activeId) initNewSubtopic();
        fetch(`/tutorial_admin/api/subtopics/${id}`).then(r=>r.json()).then(d=>{
            const l = document.getElementById('subtopic-list'); l.innerHTML='';
            if(!d.length) l.innerHTML='<div class="text-center mt-4 small text-muted">No units found</div>';
            d.forEach(i=>{
                const act = (activeId && i.id == activeId) ? 'active' : '';
                l.innerHTML+=`<div class="subtopic-item ${act}" id="sub-${i.id}" onclick="loadSubtopicDetails(${i.id})"><span>${i.title}</span><i class="fas fa-chevron-right small text-muted"></i></div>`;
            });
        });
    }

    function initNewSubtopic() {
        if(!state.topic) return;
        toggleOverlay(false); state.subtopic=null;
        document.getElementById('editor-form').reset();
        document.getElementById('edit-subtopic-id').value='';
        quillNotes.root.innerHTML=''; quillEx.root.innerHTML='';
        currentImages=[]; renderImages();
        document.getElementById('editor-header').innerText='New Unit';
        document.getElementById('btn-delete-sub').style.display='none';
        document.querySelectorAll('.subtopic-item').forEach(e=>e.classList.remove('active'));
    }

    function loadSubtopicDetails(id) {
        toggleOverlay(false);
        document.querySelectorAll('.subtopic-item').forEach(e=>e.classList.remove('active'));
        document.getElementById(`sub-${id}`).classList.add('active');
        fetch(`/tutorial_admin/api/subtopic_details/${id}`).then(r=>r.json()).then(d=>{
            state.subtopic=d.id;
            document.getElementById('edit-subtopic-id').value=d.id;
            document.getElementById('edit-title').value=d.title;
            document.getElementById('edit-desc').value=d.short_description||'';
            document.getElementById('edit-video').value=d.video_url||'';
            quillNotes.root.innerHTML=d.definition_text||'';
            const ex=d.examples||{};
            quillEx.root.innerHTML=ex.content||'';
            currentImages=ex.images||[]; renderImages();
            document.getElementById('editor-header').innerText='Editing: '+d.title;
            document.getElementById('btn-delete-sub').style.display='block';
        });
    }

    function cleanHtml(html) {
        const t=document.createElement('div'); t.innerHTML=html;
        t.querySelectorAll('img').forEach(i=>i.remove());
        t.querySelectorAll('*').forEach(e=>{
            e.removeAttribute('style'); e.removeAttribute('class');
            if(e.tagName==='SPAN') { const p=e.parentNode; while(e.firstChild)p.insertBefore(e.firstChild,e); p.removeChild(e); }
        });
        return t.innerHTML.replace(/<p><br><\/p>/g,'');
    }

    function saveSubtopic() {
        if(!state.topic) return;
        document.getElementById('hidden-notes').value = cleanHtml(quillNotes.root.innerHTML);
        const exData = { content: cleanHtml(quillEx.root.innerHTML), images: currentImages };
        document.getElementById('hidden-examples-json').value = JSON.stringify(exData);

        const fd = new FormData(document.getElementById('editor-form'));
        fd.append('topic_id', state.topic);
        fetch('/tutorial_admin/action/save_subtopic',{method:'POST',body:fd}).then(r=>r.json()).then(d=>{
            if(d.status==='success') { loadSubtopics(d.id); loadSubtopicDetails(d.id); }
        });
    }

    // --- MATH MODAL HANDLERS ---
    function openMathModal() { 
        mf.value = ""; 
        document.getElementById('latex-preview').innerText = "";
        
        // Init Bootstrap modal
        const modalEl = document.getElementById('mathModal');
        mathModalInstance = new bootstrap.Modal(modalEl);
        mathModalInstance.show();
        
        // Focus MathLive field slightly after modal animation
        setTimeout(() => { mf.focus(); }, 500);
    }

    function closeMathModal() {
        if (mathModalInstance) mathModalInstance.hide();
    }

    function insertMath() {
        if(!mf.value) { closeMathModal(); return; }
        
        const latex = ` $${mf.value}$ `;
        
        // Insert into Quill
        const range = quillEx.getSelection(true);
        if (range) {
            quillEx.insertText(range.index, latex);
            quillEx.setSelection(range.index + latex.length);
        } else {
            quillEx.insertText(quillEx.getLength(), latex);
        }
        
        closeMathModal();
    }

    function uploadImage(input) {
        const f=input.files[0]; if(!f||f.size>2*1024*1024) return alert("Max 2MB");
        const fd=new FormData(); fd.append('file',f);
        fetch('/tutorial_admin/action/upload_image',{method:'POST',body:fd}).then(r=>r.json()).then(d=>{
            if(d.location) { currentImages.push(d.location); renderImages(); }
        }).finally(()=>input.value='');
    }
    function renderImages() {
        const c=document.getElementById('image-preview-container'); c.innerHTML='';
        currentImages.forEach((u,i)=>c.innerHTML+=`<img src="${u}" class="img-thumb-mini pointer" onclick="removeImage(${i})" title="Click to remove">`);
    }
    function removeImage(i) { if(confirm('Remove image?')) { currentImages.splice(i,1); renderImages(); } }

    function resetUI(type) {
        if(type==='section') { document.getElementById('sel-section').innerHTML='<option>Loading...</option>'; document.getElementById('sel-topic').disabled=true; }
        document.getElementById('subtopic-list').innerHTML=''; toggleOverlay(true); state.topic=null;
    }
    function toggleAdd(t) { document.getElementById(`view-${t}-select`).classList.toggle('d-none'); document.getElementById(`view-${t}-add`).classList.toggle('d-none'); }
    function addItem(t) {
        const title=document.getElementById(`new-${t}-title`).value; if(!title)return;
        const fd=new FormData(); fd.append('title',title);
        const url=t==='section'?'/tutorial_admin/action/add_section':'/tutorial_admin/action/add_topic';
        fd.append(t==='section'?'level_id':'section_id', t==='section'?state.level:state.section);
        fetch(url,{method:'POST',body:fd}).then(r=>r.json()).then(d=>{ if(d.status==='success') t==='section'?loadSections():loadTopics(); });
    }
    function deleteItem() {
        if(!document.getElementById('sel-topic').value || !confirm("Delete Topic?")) return;
        fetch(`/tutorial_admin/action/delete_topic/${document.getElementById('sel-topic').value}`,{method:'DELETE'}).then(r=>r.json()).then(d=>{if(d.status==='success')loadTopics();});
    }
    function deleteSubtopic() {
        if(!state.subtopic||!confirm("Delete Unit?")) return;
        fetch(`/tutorial_admin/action/delete_subtopic/${state.subtopic}`,{method:'DELETE'}).then(r=>r.json()).then(d=>{if(d.status==='success')loadSubtopics();});
    }
</script>

{% endblock %}